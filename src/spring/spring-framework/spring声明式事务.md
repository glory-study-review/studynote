# Springå£°æ˜å¼äº‹åŠ¡

## äº”ç§å¤±æ•ˆæƒ…å†µ

1. ç±»æ²¡æœ‰è¢« Spring ç®¡ç†

2. æ–¹æ³•ä¸æ˜¯publicä¿®é¥°

3. å¼‚å¸¸è¢«æ•è·ï¼ˆäº‹åŠ¡é»˜è®¤åªåœ¨æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼‰

4. åŒä¸€ä¸ªç±»ä¸­ï¼Œæ–¹æ³•å†…éƒ¨è°ƒç”¨

   æ–¹æ³•å†…éƒ¨ä½¿ç”¨this.xxx()çš„æ–¹å¼è°ƒç”¨äº‹åŠ¡å­˜åœ¨äº‹åŠ¡çš„æ–¹æ³•ï¼›
   å¤±æ•ˆçš„æœ¬è´¨æ˜¯ï¼ŒthisæŒ‡çš„çš„æ˜¯å¯¹è±¡æœ¬èº«ï¼Œè€Œä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œäº‹åŠ¡æ˜¯ç”±AOPä»£ç†æ¥å®ç°çš„ï¼Œå¤„ç†äº‹åŠ¡çš„å¢å¼ºæ–¹æ³•éƒ½æ˜¯åœ¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ä¸­ï¼Œå› æ­¤ä½¿ç”¨thiså¯¹è±¡æœ¬èº«è°ƒç”¨æ–¹æ³•AOPä¼šå¤±æ•ˆã€‚
   ä¸ºä»€ä¹ˆthisæŒ‡çš„æ˜¯å¯¹è±¡æœ¬èº«è€Œä¸æ˜¯ä»£ç†å¯¹è±¡å‘¢ï¼ŒåŸå› ï¼Œä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³•æ—¶ï¼Œå¢å¼ºæ–¹æ³•åœ¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ä¸­ï¼Œè€ŒåŸå¯¹è±¡æ–¹æ³•è¿˜æ˜¯ä½¿ç”¨åŸå¯¹è±¡æ¥è°ƒç”¨çš„ï¼Œç”±åŸå¯¹è±¡è°ƒç”¨çš„æ–¹æ³•ä¸­ä½¿ç”¨thisï¼ŒæŒ‡å‘çš„å½“ç„¶æ—¶åŸå¯¹è±¡ã€‚
   è§£å†³ï¼Œä¸ç”¨thisè°ƒç”¨æœ¬ç±»ä¸­çš„æ–¹æ³•ï¼Œä»å®¹å™¨ä¸­è·å–beanå†è°ƒç”¨

5. MySQLå­˜å‚¨å¼•è­¦ä¸æ”¯æŒäº‹åŠ¡

https://blog.csdn.net/qq_52423918/article/details/130806813

## ä¼ æ’­è¡Œä¸º

äº‹åŠ¡åè°ƒå‘˜ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰å¯¹äº‹åŠ¡ç®¡ç†å‘˜ï¼ˆå¤–éƒ¨æ–¹æ³•ï¼‰æ˜¯å¦æºå¸¦äº‹åŠ¡è€Œè¿›è¡Œçš„å¤„ç†æ€åº¦

1.**`REQUIRED`**

å½“å¤–éƒ¨æ–¹æ³•å­˜åœ¨äº‹åŠ¡æ—¶ï¼Œå†…éƒ¨æ–¹æ³•äº‹åŠ¡å°†åŠ å…¥å¤–éƒ¨äº‹åŠ¡ï¼Œå†…éƒ¨äº‹åŠ¡äº§ç”Ÿå›æ»šæ—¶ï¼Œå¤–éƒ¨äº‹åŠ¡ä¹Ÿå›æ»š
å½“å¤–éƒ¨æ–¹æ³•ä¸å­˜åœ¨äº‹åŠ¡æ—¶ï¼Œå†…éƒ¨æ–¹æ³•äº‹åŠ¡å°±åˆ›å»ºè‡ªå·±çš„äº‹åŠ¡

2.**`REQUIRES_NEW`**

å½“å¤–éƒ¨æ–¹æ³•å­˜åœ¨äº‹åŠ¡æ—¶ï¼Œå†…éƒ¨æ–¹æ³•åˆ›å»ºè‡ªå·±ç‹¬ç«‹çš„äº‹åŠ¡ï¼Œä¸å—å¤–éƒ¨äº‹åŠ¡å½±å“
å½“å¤–éƒ¨æ–¹æ³•ä¸å­˜åœ¨äº‹åŠ¡æ—¶ï¼Œå†…éƒ¨æ–¹æ³•åˆ›å»ºè‡ªå·±ç‹¬ç«‹çš„äº‹åŠ¡

3.**`NESTED`**

å½“å¤–éƒ¨æ–¹æ³•å­˜åœ¨äº‹åŠ¡æ—¶ï¼Œå†…éƒ¨æ–¹æ³•äº‹åŠ¡æˆä¸ºå¤–éƒ¨äº‹åŠ¡çš„åµŒå¥—å­äº‹åŠ¡ï¼Œå½“å†…éƒ¨äº‹åŠ¡å›æ»šæ—¶åªä¼šå›æ»šåˆ°å†…éƒ¨äº‹åŠ¡æ‰§è¡Œå‰æŠ“é¬¼å¥—
å½“å¤–éƒ¨æ–¹æ³•ä¸å­˜åœ¨äº‹åŠ¡æ—¶ï¼Œå†…éƒ¨æ–¹æ³•åˆ›å»ºè‡ªå·±ç‹¬ç«‹çš„äº‹åŠ¡æ‰§è¡Œ

4.**`MANDATORY`**

5.**`SUPPORTS`**

å½“å¤–éƒ¨æ–¹æ³•å­˜åœ¨äº‹åŠ¡ï¼Œå†…éƒ¨æ–¹æ³•äº‹åŠ¡åŠ å…¥
å½“å¤–éƒ¨æ–¹æ³•ä¸å­˜åœ¨äº‹åŠ¡æ—¶ï¼Œå†…éƒ¨æ–¹æ³•å°±ä¸ä½¿ç”¨äº‹åŠ¡

6.**`NOT_SUPPORTED`**

ä¸ç®¡å¤–éƒ¨æ–¹æ³•æ˜¯å¦æœ‰äº‹åŠ¡ï¼Œå†…éƒ¨æ–¹æ³•çš„äº‹åŠ¡éƒ½ä¸ç”Ÿæ•ˆï¼Œæ‰§è¡Œåˆ°å†…éƒ¨æ–¹æ³•æ—¶ï¼Œå¤–éƒ¨äº‹åŠ¡æŒ‚èµ·ç­‰å¾…å†…éƒ¨æ–¹æ³•æ‰§è¡Œ

7.**`NEVER`**

æ€»æ˜¯éäº‹åŠ¡åœ°æ‰§è¡Œï¼Œå¦‚æœå¤–éƒ¨æ–¹æ³•å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

## Springäº‹åŠ¡æºç åˆ†æ

springä½¿ç”¨AOPå®ç°å£°æ˜å¼äº‹åŠ¡ï¼Œå…¶ä¸­æ¶‰åŠåˆ°è®¸å¤šé…ç½®å’Œå±æ€§è¯»å–ï¼Œå¦‚äº‹åŠ¡ç®¡ç†å™¨ã€äº‹åŠ¡ä¼ æ’­è¡Œä¸ºç­‰å¾…ï¼›

æºç åˆ†æä¹‹å‰ï¼Œéœ€è¦æ˜ç¡®Springäº‹åŠ¡å¸®æˆ‘ä»¬åšäº†ä»€ä¹ˆï¼š

- ä»æ•°æ®æ± ä¸­è·å–æ•°æ®åº“è¿æ¥
- å¼€å¯äº‹åŠ¡å¹¶è®¾ç½®æ‰‹åŠ¨æäº¤
- è°ƒç”¨åŸæ–¹æ³•
- æäº¤/å›æ»š äº‹åŠ¡

æ­¤å¤„æš‚æ—¶ç ”ç©¶springäº‹åŠ¡çš„å…·ä½“æ‰§è¡Œæµç¨‹ï¼Œä¸‹é¢å†ç ”ç©¶äº‹åŠ¡å¤„ç†æ‹¦æˆªçš„ç›¸å…³è®¾è®¡ä¸å®ç°ã€‚

æ¡ˆä¾‹

```java
public class A {
    @Transactional
    public void a() {
        Dept dept = new Dept();
        dept.setDeptName("æµ‹è¯•äº‹åŠ¡3");
        deptService.save(dept);
        B b = new B();
        b.b();
    }
}

public class B {
    @Transactional
    public void b() {
        User user = new User();
        user.setUserName("æµ‹è¯•äº‹åŠ¡");
		user.setNickName("æµ‹è¯•äº‹åŠ¡");
		user.setPassword("æµ‹è¯•äº‹åŠ¡");
		userService.save(user);
    }
}
```

ğŸ‘‡å½“æ‰§è¡Œ a()æ–¹æ³•æ—¶ï¼ŒAOPä»£ç†ä¸­ä¼šè°ƒç”¨TransactionInterceptorç±»ä¸­çš„invokeæ–¹æ³•ï¼Œæ ¸å¿ƒåœ¨å…¶çˆ¶ç±»çš„invokeWithinTransactionæ–¹æ³•ä¸­ï¼ŒåŒ…å«äº†æ•´ä¸ªäº‹åŠ¡å¤„ç†çš„è¿‡ç¨‹

![image-20240418131646439](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418131646439.png)

![image-20240418135649270](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418135649270.png)

![image-20240418135922261](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418135922261.png)

ğŸ‘‡æ¥çœ‹ä¸€ä¸‹äº‹åŠ¡å¼€å¯åšäº†ä»€ä¹ˆï¼ŒcreateTransactionIfNecessary

![image-20240418141241175](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418141241175.png)

å¼€å¯äº‹åŠ¡çš„å…·ä½“å¤„ç†ç”±äº‹åŠ¡ç®¡ç†å™¨çš„æŠ½è±¡ç±»å®šä¹‰ï¼Œä½¿ç”¨getTransactionæ¨¡æ¿æ–¹æ³•ï¼Œä¼ å…¥äº‹åŠ¡å±æ€§

![image-20240418143924879](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418143924879.png)

doGetTransaction è¿”å›ä¸€ä¸ªäº‹åŠ¡å¯¹è±¡ ç”±å…·ä½“çš„äº‹åŠ¡ç®¡ç†å™¨å®ç°ç±»å®ç° ä¸€èˆ¬ä¸ºDataSourceTransactionManager

![image-20240418145111006](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418145111006.png)

ä»äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨ä¸­è·å–æ•°æ®åº“è¿æ¥èµ„æºï¼Œè¯¥èµ„æºæ˜¯é€šè¿‡ThreadLocalä¸çº¿ç¨‹ç»‘å®šçš„ï¼ŒTransactionSynchronizationManagerä¿å­˜ç€å½“å‰çº¿ç¨‹äº‹åŠ¡ä¸­çš„äº‹åŠ¡èµ„æºå’Œä¸€äº›äº‹åŠ¡ä¿¡æ¯(å¦‚å½“å‰äº‹åŠ¡çš„åç§°ã€äº‹åŠ¡éš”ç¦»çº§åˆ«ç­‰)ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼ŒTransactionSynchronizationManagerä¸­å¹¶ä¸å­˜åœ¨èµ„æºï¼ŒConnectionHolderä¸ºnull

åˆ›å»ºä¸€ä¸ªäº‹åŠ¡å¯¹è±¡å­˜æ”¾å½“å‰äº‹åŠ¡çš„æ•°æ®è¿æ¥æŒæœ‰å¯¹è±¡ï¼Œå’Œæ˜¯å¦æ–°æŒæœ‰å¯¹è±¡æ ‡è¯†ï¼Œåç»­é€šè¿‡è¯¥æ•°æ®æŒæœ‰å¯¹è±¡è·å–è¿æ¥ã€‚

ç»§ç»­æ‰§è¡Œï¼Œåˆ¤æ–­å½“å‰æ˜¯å¦å·²å­˜åœ¨äº‹åŠ¡ï¼Œæ­¤å¤„æ˜¯å¯¹äºå­äº‹åŠ¡å¦‚ä½•å¤„ç†çš„å…¥å£

![image-20240418150902836](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418150902836.png)

![image-20240418150252044](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418150252044.png)

é€šè¿‡æŸ¥çœ‹äº‹åŠ¡å¯¹è±¡æ˜¯å¦å­˜åœ¨æ•°æ®è¿æ¥æŒæœ‰å¯¹è±¡ æ•°æ®è¿æ¥æ˜¯å¦å­˜åœ¨æ´»åŠ¨äº‹åŠ¡æ ‡å¿—ï¼Œæ¥åˆ¤æ–­æ˜¯å¦å·²å­˜åœ¨äº‹åŠ¡ï¼›å£°æ˜å¼äº‹åŠ¡æ–¹æ³•ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œæ¡ä»¶æ˜¾ç„¶ä¸æˆç«‹ï¼›

ç»§ç»­æ‰§è¡Œ

![image-20240418151242985](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418151242985.png)

é€šè¿‡å¯¹äº‹åŠ¡å±æ€§ä¸­çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºåˆ¤æ–­ï¼Œä¸‰ä¸ªå¸¸ç”¨çš„ä¼ æ’­è¡Œä¸ºï¼Œè°ƒç”¨startTransaction å¼€å¯äº‹åŠ¡

![image-20240418151729611](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418151729611.png)

è¯¥æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªäº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œä¿å­˜ç€å½“å‰äº‹åŠ¡çš„å±æ€§ï¼Œäº‹åŠ¡å¯¹è±¡ï¼Œæ˜¯å¦ä¸ºæ–°äº‹ç‰©ç­‰ç­‰ä¿¡æ¯ï¼Œç”¨äºåç»­äº‹åŠ¡å¤„ç†çš„ï¼›

ç»§ç»­æ‰§è¡Œåˆ°doBeginï¼Œç”±äº‹åŠ¡ç®¡ç†å™¨å®ç°ç±»å®ç°

![image-20240418152341645](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418152341645.png)

![image-20240418152602637](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418152602637.png)

ä¼šä»æ•°æ®æ± ä¸­è·å–è¿æ¥ï¼Œå¹¶å°†è¿æ¥æŒæœ‰å¯¹è±¡å­˜å…¥åˆ°äº‹åŠ¡å¯¹è±¡ä¸­ï¼Œè®¾ç½®æ–°æŒæœ‰å¯¹è±¡çŠ¶æ€ä¸ºtrueï¼Œç„¶åå°†è¿æ¥è®¾ä¸ºäº‹åŠ¡æ‰‹åŠ¨æäº¤ï¼›è¿æ¥æŒæœ‰å¯¹è±¡æ´»åŠ¨äº‹åŠ¡æ ‡å¿—è®¾ä¸Šï¼Œä¿è¯å‰é¢åˆ¤æ–­å·²å­˜åœ¨äº‹åŠ¡çš„æ­£ç¡®æ€§ï¼›ç”±äºæ˜¯æ–°æŒæœ‰å¯¹è±¡ï¼Œå¯æ‰§è¡ŒTransactionSynchronizationManagerçš„ç»‘å®šæ“ä½œï¼Œè¿™å°±ä¿è¯äº†ï¼Œå­äº‹åŠ¡åœ¨å¼€å¯çš„è¿‡ç¨‹ä¸­doGetTransaction()æ–¹æ³•ä¸­èƒ½å¤Ÿè·å–åŒä¸€æŒæœ‰å¯¹è±¡ã€‚

ç»§ç»­æ‰§è¡Œçš„prepareSynchronizationï¼Œå°†å½“å‰äº‹åŠ¡çš„çŠ¶æ€(å¦‚ï¼šå½“å‰äº‹åŠ¡å¼€å¯çŠ¶æ€ã€æ¿€æ´»çŠ¶æ€ã€éš”ç¦»çº§åˆ«)ã€åˆå§‹åŒ–äº‹åŠ¡åŒæ­¥å›è°ƒå†…å®¹ï¼Œå­˜æ”¾çš„æ˜¯å½“å‰éœ€è¦æ“ä½œçš„äº‹åŠ¡ä¿¡æ¯ã€‚

![image-20240418161342349](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418161342349.png)

è‡³æ­¤å¼€å¯äº‹åŠ¡ç»“æŸï¼Œè¿”å›äº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œæ‰§è¡ŒåŸæ–¹æ³•

![image-20240418162107965](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418162107965.png)

å¦‚æœå½“å‰æ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨å…¶ä»–å­˜åœ¨äº‹åŠ¡çš„æ–¹æ³•ï¼Œé‚£ä¹ˆåŸæ–¹æ³•è°ƒç”¨å®Œæˆåï¼Œç›´æ¥å›æ»šæˆ–è€…æäº¤



å…ˆçœ‹çœ‹æäº¤

![image-20240418164922781](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418164922781.png)

![image-20240418164949537](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418164949537.png)

![image-20240418165013492](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418165013492.png)

![image-20240418165106392](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418165106392.png)

![image-20240418165136584](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240418165136584.png)

æäº¤ç”±äº‹åŠ¡ç®¡ç†å™¨æŠ½è±¡ç±»æä¾›æ¨¡æ¿æ–¹æ³•ï¼Œå…¶ä¸­triggerBeforeCommit(status)å’ŒtriggerBeforeCompletion(status);æ–¹æ³•æ˜¯é€šè¿‡è·å–TransactionSynchronizationManagerä¸­é…ç½®çš„äº‹åŠ¡æäº¤å‰æ‰§è¡Œæ–¹æ³•ï¼Œè¿›è¡Œäº‹åŠ¡æäº¤å‰çš„å‰ç½®æ“ä½œï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®æƒ…å†µåœ¨TransactionSynchronizationManagerä¸­æ³¨å†Œäº‹åŠ¡å‰ç½®å’Œåç½®æ–¹æ³•ã€‚

äº‹åŠ¡ç®¡ç†å™¨çš„æäº¤æ–¹æ³•å…¶å®å°±æ˜¯è·å–å­˜å‚¨çš„äº‹åŠ¡è¿æ¥å¯¹è±¡ï¼Œæ‰‹åŠ¨commitã€‚

![image-20240419112512894](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419112512894.png)

å¯ä»¥çœ‹åˆ°ï¼Œæäº¤ä¸€å®šè¦æ˜¯äº‹åŠ¡çŠ¶æ€ä¸ºæ–°äº‹åŠ¡æ—¶ï¼Œæ‰èƒ½æäº¤ï¼›

å›åˆ°æ¡ˆä¾‹ï¼Œå½“åŸæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œåˆæ‰§è¡Œäº†ä¸€ä¸ªå£°æ˜å¼äº‹åŠ¡æ–¹æ³•b.b();

æ­¤æ—¶é‡æ–°å¼€å§‹æ‰§è¡Œä¸Šé¢åˆ†æçš„äº‹åŠ¡å¼€å¯æ–¹æ³•ï¼Œåœ¨isExistingTransactionå¤„ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªäº‹åŠ¡å¼€å¯æ—¶å°†è¿æ¥æŒæœ‰å¯¹è±¡ä¸çº¿ç¨‹ç»‘å®šç”±TransactionSynchronizationManagerç®¡ç†ï¼Œæ­¤å¤„åˆ¤æ–­ä¸ºtrue,æ‰§è¡Œå¦ä¸€åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡çš„é€»è¾‘handleExistingTransaction

![image-20240419113317485](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419113317485.png)

![image-20240419113547287](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419113547287.png)

å¯ä»¥çœ‹åˆ°ï¼Œå½“åˆ¤æ–­å·²å­˜åœ¨äº‹åŠ¡æ—¶ï¼Œä¼šæ ¹æ®äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œæ¥æ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼Œæ¡ˆä¾‹çš„å­äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ˜¯é»˜è®¤çš„PROPAGATION_REQUIREDèµ°æœ€åä¸€ä¸ªåˆ›å»ºäº‹åŠ¡çŠ¶æ€è¿‡ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°`newTransaction`ï¼Œè®¾ç½®ä¸ºäº†false

æ‰€ä»¥å½“å­äº‹åŠ¡æ–¹æ³•ï¼Œæ‰§è¡Œåˆ°æäº¤æ“ä½œæ—¶ï¼Œå¹¶ä¸ä¼šèµ°æäº¤ï¼Œçˆ¶äº‹åŠ¡æ‰§è¡Œæäº¤æ—¶æ‰ä¼šçœŸæ­£æäº¤ã€‚

æ¥çœ‹çœ‹å›æ»š

![image-20240419134726875](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419134726875.png)

åŸæ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œè¿›å…¥å¤„ç†ï¼ˆå½“åŸæ–¹æ³•æ•è·äº†å¼‚å¸¸ä½†æ˜¯ä¸æŠ›å‡ºæ–°å¼‚å¸¸ï¼Œå°±ä¼šäº‹åŠ¡å¤±æ•ˆï¼‰

![image-20240419135155738](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419135155738.png)

![image-20240419135433293](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419135433293.png)

![image-20240419135448539](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419135448539.png)

ä¼šåˆ¤æ–­å½“å‰å¼‚å¸¸æ˜¯å¦æ˜¯å®šä¹‰çš„å¼‚å¸¸ï¼Œå¦‚æœæ³¨è§£æ²¡æœ‰å®šä¹‰å›æ»šå¼‚å¸¸ï¼Œå°±ä½¿ç”¨çˆ¶ç±»æ–¹æ³•çš®é˜Ÿï¼Œå¼‚å¸¸ä¸ºRuntimeExceptionæˆ–è€…Error

åŒ¹å¯¹å¤±è´¥ç›´æ¥æ‰§è¡Œæäº¤çš„æ“ä½œï¼ŒåŒ¹å¯¹æˆåŠŸæ‰§è¡Œå›æ»šæ“ä½œï¼ˆ==æ­¤å¤„å°±æ˜¯ä¸ºä»€ä¹ˆæ–¹æ³•ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¸å®šä¹‰çš„å›æ»šå¼‚å¸¸ä¸ä¸€è‡´æ—¶ï¼Œäº‹åŠ¡å¤±æ•ˆçš„åŸå› ==ï¼‰

![image-20240419135623745](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419135623745.png)

![image-20240419140431720](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419140431720.png)

å›æ»šä¸­ï¼Œå¯¹äº‹åŠ¡çŠ¶æ€åšäº†è®¸å¤šåˆ¤æ–­ï¼Œåœ¨æ¡ˆä¾‹çš„æƒ…å†µä¸‹ï¼Œå­äº‹åŠ¡åŠ å…¥çˆ¶äº‹åŠ¡æ²¡æœ‰å¼€å¯æ–°äº‹ç‰©ï¼Œstatus.isNewTransaction()ä¸ºfalse,å°±è¿›å…¥åˆ†æ”¯æ‰§è¡ŒdoSetRollbackOnlyï¼Œä¸ºäº‹åŠ¡çš„è¿æ¥æŒæœ‰å¯¹è±¡è®¾ç½®äº†ä¸€ä¸ªå›æ»šæ ‡è®°

![image-20240419140646786](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419140646786.png)

![image-20240419141202858](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419141202858.png)

æ­¤æ—¶ä¸ç®¡çˆ¶äº‹åŠ¡çš„åŸæ–¹æ³•æ˜¯æ•è·äº†åŸäº‹åŠ¡ï¼Œè¿˜æ­£å¸¸æŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡éƒ½ä¼šå›æ»š

å¦‚æœçˆ¶äº‹åŠ¡çœŸæ­£æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£äº‹åŠ¡çŠ¶æ€ä¸­isNewTransactionä¸ºtrueï¼Œç›´æ¥å›æ»š

å¦‚æœçˆ¶äº‹åŠ¡å°†å­äº‹åŠ¡çš„å¼‚å¸¸æ•è·ä¸”æ²¡æœ‰æŠ›å‡ºæ–°å¼‚å¸¸ï¼Œé‚£çˆ¶äº‹åŠ¡å…¶å®ä¼šæ­£å¸¸è¿›å…¥æäº¤çš„æ“ä½œä½†æ˜¯æœ€åè¿˜æ˜¯ä¼šå›æ»šï¼Œä¸ºä»€ä¹ˆå¼‚å¸¸è¢«æ•è·äº‹åŠ¡æ²¡æœ‰å¤±æ•ˆï¼Œå›åˆ°æäº¤æ¨¡æ¿æ–¹æ³•ä¸­

åœ¨processCommitå‰å…¶å®è¿˜æœ‰åˆ¤æ–­

defStatus.isGlobalRollbackOnly() å…¶å®å°±æ˜¯åˆ¤æ–­ï¼Œå½“å‰è¿æ¥æŒæœ‰å¯¹è±¡ä¸­çš„å›æ»šæ ‡è®°æ˜¯å¦ä¸ºtrueï¼Œå­äº‹åŠ¡ä¸­å°†å…¶ç½®ä¸ºtrueï¼Œå› æ­¤ï¼Œçˆ¶äº‹åŠ¡è¿™é‡Œå¯¹è¿æ¥çš„äº‹åŠ¡è¿›è¡Œäº†å›æ»š

![image-20240419143313419](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419143313419.png)



## å¤šçº¿ç¨‹ä¸‹äº‹åŠ¡çš„å¤„ç†

é€šè¿‡æºç åˆ†æï¼Œspringå¤„ç†äº‹åŠ¡çš„æ–¹å¼æœ¬è´¨å°±æ˜¯å¸®æˆ‘ä»¬è·å–æ•°æ®åº“è¿æ¥ï¼Œè°ƒç”¨æ•°æ®åº“è¿æ¥çš„æ‰‹åŠ¨æäº¤å’Œå›æ»šï¼›è€Œè·å–çš„æ•°æ®åº“è¿æ¥èµ„æºç»‘å®šåœ¨çº¿ç¨‹ä¸­ç”±TransactionSynchronizationManagerå¸®å¿™ç®¡ç†ï¼Œäº‹åŠ¡å…¶å®å°±æ˜¯åŒä¸€è¿æ¥ä¸­çš„æ•°æ®åº“æ“ä½œçš„ä¸€è‡´æ€§ï¼›å¤šçº¿ç¨‹ä¸‹springå£°æ˜å¼äº‹åŠ¡çš„å¤±æ•ˆåŸå› æ˜¯çº¿ç¨‹ä¹‹é—´çš„æ•°æ®éš”ç¦»ï¼Œä¹Ÿå°±æ˜¯å¤šçº¿ç¨‹ä¸‹è·å–çš„æ•°æ®åº“è¿æ¥éƒ½ä¸ä¸€è‡´äº†ï¼Œå°±è°ˆä¸ä¸Šäº‹åŠ¡äº†ã€‚

æˆ‘ä»¬ä½¿ç”¨Mybatisæ—¶ï¼Œmybatisåœ¨æ‰§è¡Œsqlå‰ä¼šä»TransactionSynchronizationManagerä¸­å–è·å–æ•°æ®åº“è¿æ¥

![image-20240419153939135](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419153939135.png)

![image-20240419154036754](https://gitee.com/yellowish-grayish-red/pictures/raw/master/image-20240419154036754.png)

æ‰€ä»¥å¯ä»¥åœ¨å­çº¿ç¨‹è°ƒç”¨å¼€å¯äº‹åŠ¡çš„æ–¹æ³•ä¹‹å‰ï¼Œå°†ä¸»çº¿ç¨‹ä¸­è·å–åˆ°çš„æ•°æ®åº“è¿æ¥èµ„æºç»‘å®šåˆ°å­çº¿ç¨‹ä¸Šï¼Œå¹¶å°†å­çº¿ç¨‹çš„å¼‚å¸¸æ­£å¸¸æŠ›å‡ºï¼Œä¿è¯æ­£å¸¸å›æ»š

ä¾‹ï¼š

```java
@Transactional
public void test() {
    ConnectionHolder resource = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);
    System.out.println(Thread.currentThread());
    System.out.println(TransactionSynchronizationManager.getCurrentTransactionName());
    //å­çº¿ç¨‹1
    CompletableFuture<Boolean> future1 = CompletableFuture.supplyAsync(() -> {
        System.out.println(Thread.currentThread());

        TransactionSynchronizationManager.bindResource(dataSource, resource);
        Dept dept = new Dept();
        dept.setDeptName("æµ‹è¯•äº‹åŠ¡");
        return deptService.save(dept);
    }).whenComplete((result, ex) -> {
        TransactionSynchronizationManager.unbindResource(dataSource);
    });
    //å­çº¿ç¨‹2
    CompletableFuture<Boolean> future2 = CompletableFuture.supplyAsync(() -> {
        System.out.println(Thread.currentThread());
        TransactionSynchronizationManager.bindResource(dataSource, resource);
        mutiplyThreadTranscationManager.test();//å¼€å¯é»˜è®¤äº‹åŠ¡ä¼ æ’­è¡Œä¸º
        return true;
    }).whenComplete((result, ex) -> {
        TransactionSynchronizationManager.unbindResource(dataSource);
    });

    CompletableFuture.allOf(future1, future2).join();
    List<Supplier> tasks = new ArrayList<>();

    Dept dept1 = new Dept();
    dept1.setDeptName("æµ‹è¯•äº‹åŠ¡3");
    deptService.save(dept1);
    int a = 1 / 0;
}

//MutiplyThreadTranscationManager
@Transactional
public void test(){
    User user = new User();
    user.setUserName("æµ‹è¯•äº‹åŠ¡");
    user.setNickName("æµ‹è¯•äº‹åŠ¡");
    user.setPassword("æµ‹è¯•äº‹åŠ¡");
    userService.save(user);
}
```
